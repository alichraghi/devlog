<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>Zig hashmaps explained</title>
  <meta name="description" content="If you just got started with Zig, you might quickly want to use a hashmap. Zig provides good defaults, with a lot of customization options.">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="/2022/zig-hashmaps-explained">
  
  
  <link rel="alternate" type="application/rss+xml" title="Hexops&#39; devlog" href="/feed.xml">

  

  
  <meta property="og:title" content="Zig hashmaps explained">
  <meta property="og:site_name" content="Hexops&#39; devlog">
  <meta property="og:url" content="/2022/zig-hashmaps-explained">
  <meta property="og:description" content="If you just got started with Zig, you might quickly want to use a hashmap. Zig provides good defaults, with a lot of customization options.">
  
  
    <meta property="og:image" content="https://raw.githubusercontent.com/hexops/website/master/media/png/square_logo.png">
  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:title" content="Zig hashmaps explained">
  <meta name="twitter:description" content="If you just got started with Zig, you might quickly want to use a hashmap. Zig provides good defaults, with a lot of customization options.">
  
  
    <meta name="twitter:image:src" content="https://raw.githubusercontent.com/hexops/website/master/media/png/square_logo.png">
  

  <link rel="dns-prefetch" href="https://fonts.gstatic.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bitter:ital,wght@0,400;0,700;1,400&amp;display=swap" rel="stylesheet">

  

</head>


  <body>

    <header class="site-header">

    <div class="wrapper">

      <a class="site-title" href="/">
        <img alt="Hexops" class="logo color" src="https://raw.githubusercontent.com/hexops/media/main/logo.svg" style="height: 30px;">' devlog
      </a>
      <link href="/assets/font/stylesheet.css?v2" rel="stylesheet">
      <link rel="icon" sizes="any" type="image/svg+xml" href="https://raw.githubusercontent.com/hexops/website/master/media/svg/icon.svg">

      <script async defer data-domain="devlog.hexops.com" src="https://devlog.hexops.com/assets/opendata.js"></script>

      <nav class="site-nav">
        
          
          <a class="page-link" href="/about">About</a>
        
          
          <a class="page-link" href="/archives">Archives</a>
        
          
          <a class="page-link" href="https://github.com/hexops">GitHub</a>
        
      </nav>
  
    </div>
  
  </header>

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">Zig hashmaps explained</h1>
    
    <p class="post-meta"><time datetime="2022-01-29T00:00:00+00:00" itemprop="datePublished">Jan 29, 2022</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Stephen Gutekanst</span></span> •
  
    
    
      
    
      
    
      
        <a href="/categories/zig/">zig,</a>,
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/categories/hashmaps/">hashmaps</a>
      
    
      
    
  



</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>If you just got started with <a href="https://ziglang.org">Zig</a>, you might quickly want to use a hashmap. Zig provides good defaults, with a lot of customization options.</p>

<p>Here I will try to guide you into choosing the right hashmap type.</p>

<h2 id="60-second-explainer">60-second explainer</h2>

<p>You probably want:</p>

<div class="language-zig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">my_hash_map</span> <span class="o">=</span> <span class="n">std</span><span class="p">.</span><span class="nf">StringHashMap</span><span class="p">(</span><span class="n">V</span><span class="p">).</span><span class="nf">init</span><span class="p">(</span><span class="n">allocator</span><span class="p">);</span>
</code></pre></div></div>

<p>Or if you do not have string keys, you can use an <code class="language-plaintext highlighter-rouge">Auto</code> hashmap instead:</p>

<div class="language-zig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">my_hash_map</span> <span class="o">=</span> <span class="n">std</span><span class="p">.</span><span class="nf">AutoHashMap</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">).</span><span class="nf">init</span><span class="p">(</span><span class="n">allocator</span><span class="p">);</span>
</code></pre></div></div>

<p>Where <code class="language-plaintext highlighter-rouge">K</code> and <code class="language-plaintext highlighter-rouge">V</code> are your key and value data types, respectively. e.g. <code class="language-plaintext highlighter-rouge">[]const u8</code> for a string.</p>

<p>You can then use these APIs:</p>

<h3 id="insert-a-value">Insert a value</h3>

<div class="language-zig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span> <span class="n">my_hash_map</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="insert-a-value-assert-entry-does-not-already-exist">Insert a value, assert entry does not already exist</h3>

<div class="language-zig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span> <span class="n">my_hash_map</span><span class="p">.</span><span class="nf">putNoClobber</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</code></pre></div></div>

<p>Note <code class="language-plaintext highlighter-rouge">putNoClobber</code> may be renamed to something like <code class="language-plaintext highlighter-rouge">putAssumeNoEntry</code> in the near future: <a href="https://github.com/ziglang/zig/issues/10736">ziglang/zig#10736</a></p>

<h3 id="get-a-value">Get a value</h3>

<div class="language-zig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">value</span> <span class="o">=</span> <span class="n">my_hash_map</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">|</span><span class="n">v</span><span class="p">|</span> <span class="p">{</span>
    <span class="c">// got value "v"</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c">// doesn't exist</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="get-a-value-insert-if-not-exist">Get a value, insert if not exist</h3>

<div class="language-zig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">v</span> <span class="o">=</span> <span class="k">try</span> <span class="n">my_hash_map</span><span class="p">.</span><span class="nf">getOrPut</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v</span><span class="p">.</span><span class="py">found_existing</span><span class="p">)</span> <span class="p">{</span>
    <span class="c">// We inserted an entry, specify the new value</span>
    <span class="c">// This is a conditional in case creating the new value is expensive</span>
    <span class="n">v</span><span class="p">.</span><span class="py">value_ptr</span><span class="o">.*</span> <span class="o">=</span> <span class="s">"my value"</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">var</span> <span class="n">value</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="py">value_ptr</span><span class="o">.*</span><span class="p">;</span> <span class="c">// use the value</span>
</code></pre></div></div>

<p>You can find more APIs <a href="https://github.com/ziglang/zig/blob/master/lib/std/hash_map.zig#L342">by going here</a> and using your browser’s builtin search for <code class="language-plaintext highlighter-rouge">pub fn</code>.</p>

<h2 id="about-key-data-types">About key data types</h2>

<p>Zig hash map types start with the data type of the key:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">std.StringHashMap</code> - uses a good default hashing function for string keys</li>
  <li><code class="language-plaintext highlighter-rouge">std.AutoHashMap</code> - uses a good default hashing function for most data types</li>
  <li><code class="language-plaintext highlighter-rouge">std.HashMap</code> - the “bring your own hashing function” option</li>
</ul>

<p>Note: <code class="language-plaintext highlighter-rouge">AutoHashMap</code> does not support <em>slices</em>, such as <code class="language-plaintext highlighter-rouge">[]const u8</code> string slices, because that is a pointer to an array and it is ambiguous whether or not you intend to hash <em>the array elements</em> or <em>the pointer itself</em>. You can use the generic <code class="language-plaintext highlighter-rouge">std.HashMap</code> for any slice type, you just have to provide your own hash functions.</p>

<h2 id="hashmaps-are-also-sets">Hashmaps are also sets</h2>

<p>A set in Zig is just a hashmap with a <code class="language-plaintext highlighter-rouge">void</code> value:</p>

<div class="language-zig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">my_hash_map</span> <span class="o">=</span> <span class="n">std</span><span class="p">.</span><span class="nf">AutoHashMap</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="k">void</span><span class="p">).</span><span class="nf">init</span><span class="p">(</span><span class="n">allocator</span><span class="p">);</span>

<span class="k">try</span> <span class="n">my_hash_map</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{});</span> <span class="c">// `{}` is a value of type `void`</span>
</code></pre></div></div>

<h2 id="advanced-usages">Advanced usages</h2>

<p>If you’re just getting started with Zig, don’t worry too much about the below. Just know that you have options available should you need to reduce memory usage or optimize your use of hashmaps in the future.</p>

<h3 id="managed-vs-unmanaged-hashmaps">Managed vs. unmanaged hashmaps</h3>

<p>You can add <code class="language-plaintext highlighter-rouge">Unmanaged</code> to the end of a Zig hashmap data type, e.g. <code class="language-plaintext highlighter-rouge">std.StringHashMapUnmanaged</code> in order to get the <em>unmanaged</em> version.</p>

<p>This merely doesn’t carry an <code class="language-plaintext highlighter-rouge">allocator</code> internally, instead you must pass the allocator into every method of the hashmap. While only a few bytes, this can be a useful optimization if you’re storing many hashmaps for example.</p>

<p>Managed:</p>

<div class="language-zig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">my_hash_map</span> <span class="o">=</span> <span class="n">std</span><span class="p">.</span><span class="nf">StringHashMap</span><span class="p">(</span><span class="n">V</span><span class="p">).</span><span class="nf">init</span><span class="p">(</span><span class="n">allocator</span><span class="p">);</span>
</code></pre></div></div>

<p>Unmanaged:</p>

<div class="language-zig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">my_hash_map</span> <span class="o">=</span> <span class="n">std</span><span class="p">.</span><span class="nf">StringHashMapUnmanaged</span><span class="p">(</span><span class="n">V</span><span class="p">){};</span>
</code></pre></div></div>

<h3 id="array-hash-maps">Array hash maps</h3>

<p>Zig actually provides <a href="https://github.com/ziglang/zig/pull/5999"><em>two hashmap implementations</em></a> in the standard library</p>

<p><code class="language-plaintext highlighter-rouge">std.HashMap</code>, perfect for every-day use cases:</p>

<ul>
  <li>Optimized for lookup times primarily</li>
  <li>Optimized for insertion/removal times secondarily</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">std.ArrayHashMap</code>, useful in <em>some</em> situations:</p>

<ul>
  <li>Iterating over the hashmap is an order of magnitude faster (a contiguous array)</li>
  <li>Insertion order is preserved.</li>
  <li>You can index into the underlying data like an array if you like</li>
  <li>Deletions can be performed one of two ways, mirroring the <code class="language-plaintext highlighter-rouge">ArrayList</code> API:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">swapRemove</code>: swaps the target element with the last element in the list to remove it</li>
      <li><code class="language-plaintext highlighter-rouge">orderedRemove</code>: removes target element by shifting all elements forward, maintaining current ordering</li>
    </ul>
  </li>
</ul>

<h3 id="hashmap-context">Hashmap context</h3>

<p>If you choose to use <code class="language-plaintext highlighter-rouge">std.HashMap</code> or <code class="language-plaintext highlighter-rouge">std.ArrayHashMap</code> directly (without the <code class="language-plaintext highlighter-rouge">String</code> or <code class="language-plaintext highlighter-rouge">Auto</code> prefix), then you’ll find it wants a <em>context</em> parameter and <em>max load percentage</em>:</p>

<div class="language-zig highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">my_hash_map</span> <span class="o">=</span> <span class="n">std</span><span class="p">.</span><span class="nf">HashMap</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">std</span><span class="p">.</span><span class="py">hash_map</span><span class="p">.</span><span class="nf">AutoContext</span><span class="p">(</span><span class="n">K</span><span class="p">),</span> <span class="n">std</span><span class="p">.</span><span class="py">hash_map</span><span class="p">.</span><span class="py">default_max_load_percentage</span><span class="p">);</span>
</code></pre></div></div>

<p>The <em>context</em> parameter lets you embed some of your own data within the hash map type. This can be useful for <a href="https://zig.news/andrewrk/how-to-use-hash-map-contexts-to-save-memory-when-doing-a-string-table-3l33">reducing the amount of memory that a hash map takes up when doing a string table</a>.</p>

<h3 id="pick-your-hashmap">Pick your hashmap</h3>

<p>Regular implementation:</p>

<table>
  <thead>
    <tr>
      <th>Key type</th>
      <th>Managed?</th>
      <th>How to initialize</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">String</code></td>
      <td>yes</td>
      <td><code class="language-plaintext highlighter-rouge">std.StringHashMap(V).init(allocator)</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Auto</code></td>
      <td>yes</td>
      <td><code class="language-plaintext highlighter-rouge">std.AutoHashMap(K, V).init(allocator)</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">String</code></td>
      <td><code class="language-plaintext highlighter-rouge">Unmanaged</code></td>
      <td><code class="language-plaintext highlighter-rouge">std.StringHashMapUnmanaged(V){}</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Auto</code></td>
      <td><code class="language-plaintext highlighter-rouge">Unmanaged</code></td>
      <td><code class="language-plaintext highlighter-rouge">std.AutoHashMapUnmanaged(K, V){}</code></td>
    </tr>
  </tbody>
</table>

<p><code class="language-plaintext highlighter-rouge">ArrayHashMap</code> implementation:</p>

<table>
  <thead>
    <tr>
      <th>Key type</th>
      <th>Managed?</th>
      <th>How to initialize</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">String</code></td>
      <td>yes</td>
      <td><code class="language-plaintext highlighter-rouge">std.StringArrayHashMap(V).init(allocator)</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Auto</code></td>
      <td>yes</td>
      <td><code class="language-plaintext highlighter-rouge">std.AutoArrayHashMap(K, V).init(allocator)</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">String</code></td>
      <td><code class="language-plaintext highlighter-rouge">Unmanaged</code></td>
      <td><code class="language-plaintext highlighter-rouge">std.StringArrayHashMapUnmanaged(V){}</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Auto</code></td>
      <td><code class="language-plaintext highlighter-rouge">Unmanaged</code></td>
      <td><code class="language-plaintext highlighter-rouge">std.AutoArrayHashMapUnmanaged(K, V){}</code></td>
    </tr>
  </tbody>
</table>

<h3 id="learn-more">Learn more</h3>

<p>The source code is very readable:</p>

<ul>
  <li><a href="https://github.com/ziglang/zig/blob/master/lib/std/hash_map.zig"><code class="language-plaintext highlighter-rouge">std.HashMap</code></a></li>
  <li><a href="https://github.com/ziglang/zig/blob/master/lib/std/hash_map.zig"><code class="language-plaintext highlighter-rouge">std.ArrayHashMap</code></a></li>
</ul>

<h3 id="help-improve-this-page">Help improve this page</h3>

<p>I wrote this article quickly because I needed to explain my choice of hashmaps in the <a href="https://devlog.hexops.com/categories/build-an-ecs/">“Let’s build an Entity Component System from scratch”</a> series and there was no better source of this info. I’m sure there are things that can be improved.</p>

<p><a href="https://github.com/hexops/devlog/blob/main/_posts/2022-01-29-zig-hashmaps-explained.md">Feel free to send a PR!</a></p>

  </div>

  

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      <a alt="Twitter" href="https://twitter.com/slimsag""><img src="https://shields.io/badge/Twitter-follow-blue?logo=Twitter" class="color"></a>
&nbsp;
<a alt="RSS Follow" href="/feed.xml""><img src="https://shields.io/badge/RSS-follow-green?logo=RSS" class="color"></a>
&nbsp;
<a alt="License: CC BY 4.0" href="https://creativecommons.org/licenses/by/4.0"><img src="https://img.shields.io/badge/License-CC%20BY%204.0-lightgrey.svg" class="color"></a>
&nbsp;
<a alt="Hexops on GitHub" href="https://github.com/hexops" class="github color" style="background-image: url(https://raw.githubusercontent.com/simple-icons/simple-icons/develop/icons/github.svg);line-height: 1;padding-left: 1.5rem;background-repeat: no-repeat;padding-top: .25rem;"> GitHub</a>
<br>
<br>
<a href="https://hexops.com"><img class="logo color" height="50px" alt="Hexops logo" src="https://raw.githubusercontent.com/hexops/media/main/logo.svg"></a>
<br>


&copy;  2021 Hexops
<link rel="me" href="mailto:support@hexops.com">
    </p>

  </div>

</footer>


  </body>

</html>
